<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17791984182"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17791984182');
    </script>

    <title>R√©server | Florent VTC</title>
    <link rel="icon" type="image/svg+xml" href="logo-florent-vtc.svg">
    <link rel="apple-touch-icon" href="logo-florent-vtc.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Google Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpNFQlTYuGzsjIUcMM-643vSZ3V6z6W5c&libraries=places&language=fr"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        :root {
            --black: #0a0a0a;
            --white: #fff;
            --gray: rgba(255,255,255,0.6);
            --border: rgba(212,175,55,0.2);
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --gold-dark: #b8962e;
            --green: #22c55e;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--black);
            color: var(--white);
            line-height: 1.6;
            min-height: 100vh;
        }

        a { color: inherit; text-decoration: none; }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .logo { font-size: 20px; font-weight: 600; }

        .header-phone {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
            font-size: 14px;
        }

        /* Main */
        main {
            max-width: 600px;
            margin: 0 auto;
            padding: 100px 24px 120px;
        }

        h1 {
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 40px;
        }

        /* Progress */
        .progress {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 40px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            background: var(--border);
            transition: all 0.3s;
        }

        .progress-number.active {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
        }

        .progress-label {
            font-size: 14px;
            color: var(--gray);
        }

        .progress-label.active {
            color: var(--white);
        }

        .progress-line {
            width: 40px;
            height: 2px;
            background: var(--border);
            align-self: center;
        }

        .progress-line.active {
            background: linear-gradient(90deg, var(--gold), var(--gold-dark));
        }

        /* Form */
        .form-step { display: none; }
        .form-step.active { display: block; }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        input, select, textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--white);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--gold);
        }

        input[type="date"], input[type="time"] {
            color-scheme: dark;
        }

        select option {
            background: #111;
        }

        textarea {
            resize: none;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Destination cards */
        .destination-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .destination-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .destination-card:hover {
            background: rgba(255,255,255,0.08);
        }

        .destination-card.selected {
            border-color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .destination-card .name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .destination-card .price {
            color: var(--gold);
            font-weight: 700;
            font-size: 18px;
        }

        /* Price estimation */
        .price-estimation {
            background: linear-gradient(135deg, rgba(212,175,55,0.1), rgba(184,150,46,0.1));
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 16px;
            padding: 20px;
            margin-top: 16px;
            display: none;
        }

        .price-estimation.visible {
            display: block;
        }

        .price-estimation .price-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .price-estimation .price-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .price-estimation .price-details {
            font-size: 13px;
            color: var(--gray);
            margin-top: 8px;
        }

        .price-estimation .price-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Summary */
        .summary {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary h3 {
            font-size: 16px;
            margin-bottom: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .summary-row .label { color: var(--gray); }

        .summary-total {
            border-top: 1px solid var(--border);
            margin-top: 12px;
            padding-top: 12px;
        }

        .summary-total .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
        }

        .edit-btn {
            color: var(--gold);
            font-size: 14px;
            cursor: pointer;
            margin-top: 12px;
            display: inline-block;
        }

        .edit-btn:hover { text-decoration: underline; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: var(--black);
            font-weight: 600;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212,175,55,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .help-text {
            font-size: 13px;
            color: var(--gray);
            margin-top: 8px;
        }

        .note {
            text-align: center;
            font-size: 13px;
            color: var(--gray);
            margin-top: 16px;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .autocomplete-list.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: rgba(255,255,255,0.05);
        }

        @media (max-width: 500px) {
            .form-row { grid-template-columns: 1fr; }
            .destination-grid { grid-template-columns: 1fr; }
            .btn-group { grid-template-columns: 1fr; }
        }

        /* Google Places Autocomplete Styling */
        .pac-container {
            background: #111 !important;
            border: 1px solid rgba(212,175,55,0.2) !important;
            border-radius: 12px !important;
            margin-top: 4px !important;
            font-family: 'Inter', -apple-system, sans-serif !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important;
            z-index: 9999 !important;
        }

        .pac-item {
            padding: 12px 16px !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
            cursor: pointer !important;
            color: #fff !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
        }

        .pac-item:hover, .pac-item-selected {
            background: rgba(212,175,55,0.1) !important;
        }

        .pac-item-query {
            color: #fff !important;
            font-weight: 500 !important;
            font-size: 14px !important;
        }

        .pac-matched {
            color: var(--gold) !important;
            font-weight: 600 !important;
        }

        .pac-icon {
            display: none !important;
        }

        .pac-item span:last-child {
            color: rgba(255,255,255,0.5) !important;
            font-size: 12px !important;
        }

        .pac-logo::after {
            display: none !important;
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">Florent VTC</a>
        <a href="tel:0683669716" class="header-phone">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
            <span>06 83 66 97 16</span>
        </a>
    </header>

    <main>
        <h1>R√©server votre course</h1>
        <p class="subtitle">R√©ponse garantie en moins de 30 minutes</p>

        <div class="progress">
            <div class="progress-step">
                <div class="progress-number active" id="progress1">1</div>
                <span class="progress-label active" id="label1">Trajet</span>
            </div>
            <div class="progress-line" id="line1"></div>
            <div class="progress-step">
                <div class="progress-number" id="progress2">2</div>
                <span class="progress-label" id="label2">Coordonn√©es</span>
            </div>
        </div>

        <form id="reservationForm">
            <!-- Step 1: Trajet -->
            <div class="form-step active" id="step1">
                <div class="form-group">
                    <label>Type de trajet</label>
                    <div class="destination-grid" id="destinationGrid">
                        <div class="destination-card selected" data-value="cdg" data-price="65">
                            <div class="name">Paris ‚Üí CDG</div>
                            <div class="price">65‚Ç¨</div>
                        </div>
                        <div class="destination-card" data-value="orly" data-price="55">
                            <div class="name">Paris ‚Üí Orly</div>
                            <div class="price">55‚Ç¨</div>
                        </div>
                        <div class="destination-card" data-value="beauvais" data-price="120">
                            <div class="name">Paris ‚Üí Beauvais</div>
                            <div class="price">120‚Ç¨</div>
                        </div>
                        <div class="destination-card" data-value="gare" data-price="35">
                            <div class="name">Transfert Gare</div>
                            <div class="price">√Ä partir de 35‚Ç¨</div>
                        </div>
                        <div class="destination-card" data-value="custom" data-price="0">
                            <div class="name">üìç Autre trajet</div>
                            <div class="price">Calcul automatique</div>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="customAddresses" style="display:none">
                    <div class="form-row">
                        <div class="autocomplete-container">
                            <label>Adresse de d√©part</label>
                            <input type="text" id="customDepart" placeholder="Ex: 10 rue de Rivoli, Paris" autocomplete="off">
                            <div class="autocomplete-list" id="departList"></div>
                        </div>
                        <div class="autocomplete-container">
                            <label>Adresse d'arriv√©e</label>
                            <input type="text" id="customArrivee" placeholder="Ex: A√©roport CDG T2" autocomplete="off">
                            <div class="autocomplete-list" id="arriveeList"></div>
                        </div>
                    </div>

                    <!-- Prix estim√© -->
                    <div class="price-estimation" id="priceEstimation">
                        <div id="priceLoading" class="price-loading" style="display:none">
                            <div class="spinner"></div>
                            <span>Calcul du prix en cours...</span>
                        </div>
                        <div id="priceResult" style="display:none">
                            <div class="price-label">Prix estim√©</div>
                            <div class="price-value" id="estimatedPrice">-</div>
                            <div class="price-details" id="priceDetails">-</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label>Heure de prise en charge</label>
                        <input type="time" id="heure" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Passagers</label>
                        <select id="passengers">
                            <option value="1">1 passager</option>
                            <option value="2">2 passagers</option>
                            <option value="3">3 passagers</option>
                            <option value="4">4 passagers</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bagages</label>
                        <select id="luggage">
                            <option value="0">0 bagage</option>
                            <option value="1" selected>1 bagage</option>
                            <option value="2">2 bagages</option>
                            <option value="3">3 bagages</option>
                            <option value="4">4 bagages</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="flightGroup">
                    <label>Num√©ro de vol (optionnel)</label>
                    <input type="text" id="flightNumber" placeholder="Ex: AF1234">
                    <p class="help-text">Permet de suivre votre vol et d'adapter l'heure de prise en charge</p>
                </div>

                <button type="button" class="btn btn-primary" onclick="goToStep(2)">Continuer</button>
            </div>

            <!-- Step 2: Coordonn√©es -->
            <div class="form-step" id="step2">
                <div class="summary" id="summary">
                    <h3>R√©sum√© de votre r√©servation</h3>
                    <div class="summary-row">
                        <span class="label">Trajet</span>
                        <span class="value" id="summaryTrajet">-</span>
                    </div>
                    <div class="summary-row" id="summaryDistanceRow" style="display:none">
                        <span class="label">Distance</span>
                        <span class="value" id="summaryDistance">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Date</span>
                        <span class="value" id="summaryDate">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Heure</span>
                        <span class="value" id="summaryHeure">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="label">Passagers / Bagages</span>
                        <span class="value" id="summaryDetails">-</span>
                    </div>
                    <div class="summary-row summary-total" id="summaryPriceRow">
                        <span class="label">Prix</span>
                        <span class="value" id="summaryPrice">-</span>
                    </div>
                    <span class="edit-btn" onclick="goToStep(1)">Modifier</span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Pr√©nom</label>
                        <input type="text" id="prenom" required>
                    </div>
                    <div class="form-group">
                        <label>Nom</label>
                        <input type="text" id="nom" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>T√©l√©phone</label>
                    <input type="tel" id="telephone" placeholder="06 XX XX XX XX" required>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="votre@email.com" required>
                </div>

                <div class="form-group">
                    <label>Notes (optionnel)</label>
                    <textarea id="notes" placeholder="Informations compl√©mentaires, demandes sp√©ciales..."></textarea>
                </div>

                <!-- Code Parrainage -->
                <div class="form-group">
                    <label>Code parrainage (optionnel)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="codeParrain" placeholder="Ex: VTC-JEAN" style="flex: 1; text-transform: uppercase;">
                        <button type="button" id="btnVerifierCode" class="btn btn-secondary" style="width: auto; padding: 16px 20px;">Appliquer</button>
                    </div>
                    <p class="help-text">Vous avez un code parrain ? Entrez-le pour b√©n√©ficier de -10‚Ç¨ sur votre course</p>
                    <div id="codeParrainResult" style="display: none; margin-top: 10px; padding: 12px; border-radius: 8px;"></div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Retour</button>
                    <button type="submit" class="btn btn-primary">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347"/></svg>
                        R√©server via WhatsApp
                    </button>
                </div>

                <p class="note">En cliquant sur R√©server, vous serez redirig√© vers WhatsApp pour confirmer</p>
            </div>
        </form>
    </main>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function() {
            emailjs.init("8TM4VHehBJTzDMT-s");
        })();
    </script>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://ihhatfwgtswtsmzesczc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloaGF0ZndndHN3dHNtemVzY3pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNjQzMTQsImV4cCI6MjA4MDc0MDMxNH0.uNcB-MF7QDKidbesjTOEHXMP0bszxYll3L2E5sirsAY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Configuration tarifs
        const PRIX_KM = 2.20;
        const PRISE_EN_CHARGE = 8;
        const MINIMUM_COURSE = 25;

        // Tarifs fixes
        const TARIFS = {
            cdg: { name: 'Paris ‚Üí CDG', price: 65 },
            orly: { name: 'Paris ‚Üí Orly', price: 55 },
            beauvais: { name: 'Paris ‚Üí Beauvais', price: 120 },
            gare: { name: 'Transfert Gare', price: 35 },
            custom: { name: 'Trajet personnalis√©', price: 0 }
        };

        let selectedDestination = 'cdg';
        let calculatedPrice = 0;
        let calculatedDistance = 0;
        let departCoords = null;
        let arriveeCoords = null;
        let codeParrainValide = null;
        let reductionParrainage = 0;
        const REDUCTION_PARRAINAGE = 10; // -10‚Ç¨

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').min = today;

            const params = new URLSearchParams(window.location.search);

            // Si on vient de l'estimateur avec des adresses personnalis√©es
            const departParam = params.get('depart');
            const destParam = params.get('destination');
            const dateParam = params.get('date');
            const heureParam = params.get('heure');
            const passengersParam = params.get('passengers');
            const luggageParam = params.get('luggage');
            const priceParam = params.get('price');

            if (departParam && destParam) {
                // Trajet personnalis√© depuis l'estimateur
                selectDestination('custom');
                document.getElementById('customDepart').value = departParam;
                document.getElementById('customArrivee').value = destParam;

                if (priceParam && parseInt(priceParam) > 0) {
                    calculatedPrice = parseInt(priceParam);
                    document.getElementById('priceEstimation').classList.add('visible');
                    document.getElementById('priceLoading').style.display = 'none';
                    document.getElementById('priceResult').style.display = 'block';
                    document.getElementById('estimatedPrice').textContent = calculatedPrice + '‚Ç¨';
                    document.getElementById('priceDetails').textContent = 'Prix estim√© depuis la page d\'accueil';
                }
            } else if (destParam && TARIFS[destParam]) {
                // Forfait classique (cdg, orly, beauvais, gare)
                selectDestination(destParam);
            }

            // Pr√©-remplir date/heure/passagers/bagages si fournis
            if (dateParam) document.getElementById('date').value = dateParam;
            if (heureParam) document.getElementById('heure').value = heureParam;
            if (passengersParam) document.getElementById('passengers').value = passengersParam;
            if (luggageParam) document.getElementById('luggage').value = luggageParam;

            document.querySelectorAll('.destination-card').forEach(card => {
                card.addEventListener('click', () => {
                    selectDestination(card.dataset.value);
                });
            });

            // Autocomplete pour les adresses
            setupAutocomplete('customDepart', 'departList', (coords) => {
                departCoords = coords;
                calculatePrice();
            });
            setupAutocomplete('customArrivee', 'arriveeList', (coords) => {
                arriveeCoords = coords;
                calculatePrice();
            });

            // V√©rification code parrainage
            document.getElementById('btnVerifierCode').addEventListener('click', verifierCodeParrain);
            document.getElementById('codeParrain').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifierCodeParrain();
                }
            });
        });

        // V√©rifier le code parrainage
        async function verifierCodeParrain() {
            const codeInput = document.getElementById('codeParrain');
            const code = codeInput.value.trim().toUpperCase();
            const resultDiv = document.getElementById('codeParrainResult');

            if (!code) {
                resultDiv.style.display = 'none';
                return;
            }

            // V√©rifier dans Supabase
            try {
                const { data, error } = await supabase
                    .from('codes_parrainage')
                    .select('*')
                    .eq('code', code)
                    .eq('actif', true)
                    .single();

                if (data) {
                    // Code valide
                    codeParrainValide = data;
                    reductionParrainage = REDUCTION_PARRAINAGE;
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = 'rgba(34, 197, 94, 0.1)';
                    resultDiv.style.border = '1px solid rgba(34, 197, 94, 0.3)';
                    resultDiv.innerHTML = `<span style="color: #22c55e; font-weight: 600;">‚úì Code valide ! -${REDUCTION_PARRAINAGE}‚Ç¨ appliqu√©s</span><br><span style="color: var(--gray); font-size: 13px;">Parrain : ${data.client_name}</span>`;
                    updateSummary();
                } else {
                    // Code invalide
                    codeParrainValide = null;
                    reductionParrainage = 0;
                    resultDiv.style.display = 'block';
                    resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                    resultDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                    resultDiv.innerHTML = '<span style="color: #ef4444; font-weight: 600;">‚úó Code invalide ou expir√©</span>';
                    updateSummary();
                }
            } catch (err) {
                codeParrainValide = null;
                reductionParrainage = 0;
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                resultDiv.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                resultDiv.innerHTML = '<span style="color: #ef4444; font-weight: 600;">‚úó Code invalide ou expir√©</span>';
            }
        }

        function selectDestination(value) {
            selectedDestination = value;

            document.querySelectorAll('.destination-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.value === value);
            });

            const customSection = document.getElementById('customAddresses');
            customSection.style.display = value === 'custom' ? 'block' : 'none';

            document.getElementById('flightGroup').style.display =
                ['cdg', 'orly', 'beauvais'].includes(value) ? 'block' : 'none';

            // Reset prix calcul√©
            if (value !== 'custom') {
                calculatedPrice = 0;
                calculatedDistance = 0;
                document.getElementById('priceEstimation').classList.remove('visible');
            }
        }

        // Autocomplete avec Google Places API (comme Waze)
        function setupAutocomplete(inputId, listId, onSelect) {
            const input = document.getElementById(inputId);

            // Configuration Google Places Autocomplete
            const autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['geocode', 'establishment'],
                componentRestrictions: { country: 'fr' },
                fields: ['formatted_address', 'geometry', 'name']
            });

            // Quand l'utilisateur s√©lectionne une adresse
            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();

                if (place.geometry && place.geometry.location) {
                    const coords = {
                        lat: place.geometry.location.lat(),
                        lon: place.geometry.location.lng()
                    };
                    onSelect(coords);
                }
            });

            // Emp√™cher le formulaire de se soumettre avec Entr√©e
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
        }

        // Calculer le prix
        function calculatePrice() {
            if (!departCoords || !arriveeCoords) return;

            const estimation = document.getElementById('priceEstimation');
            const loading = document.getElementById('priceLoading');
            const result = document.getElementById('priceResult');

            estimation.classList.add('visible');
            loading.style.display = 'flex';
            result.style.display = 'none';

            // Calcul de la distance avec l'API OSRM (gratuit)
            fetch(`https://router.project-osrm.org/route/v1/driving/${departCoords.lon},${departCoords.lat};${arriveeCoords.lon},${arriveeCoords.lat}?overview=false`)
                .then(res => res.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const distanceM = data.routes[0].distance;
                        const distanceKm = distanceM / 1000;
                        const durationMin = Math.round(data.routes[0].duration / 60);

                        calculatedDistance = distanceKm;

                        // Calcul du prix
                        let price = PRISE_EN_CHARGE + (distanceKm * PRIX_KM);
                        price = Math.max(price, MINIMUM_COURSE);
                        price = Math.ceil(price / 5) * 5; // Arrondi aux 5‚Ç¨ sup√©rieurs

                        calculatedPrice = price;

                        loading.style.display = 'none';
                        result.style.display = 'block';
                        document.getElementById('estimatedPrice').textContent = price + '‚Ç¨';
                        document.getElementById('priceDetails').textContent =
                            `${distanceKm.toFixed(1)} km ‚Ä¢ ~${durationMin} min de trajet`;
                    } else {
                        showPriceError();
                    }
                })
                .catch(() => {
                    showPriceError();
                });
        }

        function showPriceError() {
            const loading = document.getElementById('priceLoading');
            const result = document.getElementById('priceResult');

            loading.style.display = 'none';
            result.style.display = 'block';
            document.getElementById('estimatedPrice').textContent = 'Sur devis';
            document.getElementById('priceDetails').textContent = 'Contactez-nous pour un tarif pr√©cis';
            calculatedPrice = 0;
        }

        function goToStep(step) {
            if (step === 2) {
                const date = document.getElementById('date').value;
                const heure = document.getElementById('heure').value;

                if (!date || !heure) {
                    alert('Veuillez remplir la date et l\'heure');
                    return;
                }

                if (selectedDestination === 'custom') {
                    const depart = document.getElementById('customDepart').value;
                    const arrivee = document.getElementById('customArrivee').value;
                    if (!depart || !arrivee) {
                        alert('Veuillez remplir les adresses de d√©part et d\'arriv√©e');
                        return;
                    }
                }

                updateSummary();
            }

            document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');

            document.getElementById('progress1').classList.toggle('active', step >= 1);
            document.getElementById('progress2').classList.toggle('active', step >= 2);
            document.getElementById('label1').classList.toggle('active', step >= 1);
            document.getElementById('label2').classList.toggle('active', step >= 2);
            document.getElementById('line1').classList.toggle('active', step >= 2);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateSummary() {
            const tarif = TARIFS[selectedDestination];
            const date = document.getElementById('date').value;
            const heure = document.getElementById('heure').value;
            const passengers = document.getElementById('passengers').value;
            const luggage = document.getElementById('luggage').value;

            let trajetName = tarif.name;
            let price = tarif.price;

            if (selectedDestination === 'custom') {
                const depart = document.getElementById('customDepart').value.split(',')[0];
                const arrivee = document.getElementById('customArrivee').value.split(',')[0];
                trajetName = depart + ' ‚Üí ' + arrivee;
                price = calculatedPrice;

                if (calculatedDistance > 0) {
                    document.getElementById('summaryDistance').textContent = calculatedDistance.toFixed(1) + ' km';
                    document.getElementById('summaryDistanceRow').style.display = 'flex';
                }
            } else {
                document.getElementById('summaryDistanceRow').style.display = 'none';
            }

            document.getElementById('summaryTrajet').textContent = trajetName;

            const dateObj = new Date(date);
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('summaryDate').textContent = dateObj.toLocaleDateString('fr-FR', options);

            document.getElementById('summaryHeure').textContent = heure;
            document.getElementById('summaryDetails').textContent = passengers + ' pers. / ' + luggage + ' bag.';

            if (price > 0) {
                let finalPrice = price;
                let priceHTML = price + '‚Ç¨';

                if (reductionParrainage > 0) {
                    finalPrice = Math.max(0, price - reductionParrainage);
                    priceHTML = `<span style="text-decoration: line-through; color: var(--gray); font-size: 16px;">${price}‚Ç¨</span> <span style="color: #22c55e;">${finalPrice}‚Ç¨</span>`;
                }

                document.getElementById('summaryPrice').innerHTML = priceHTML;
                document.getElementById('summaryPriceRow').style.display = 'flex';
            } else {
                document.getElementById('summaryPrice').textContent = 'Sur devis';
                document.getElementById('summaryPriceRow').style.display = 'flex';
            }
        }

        // Form submit
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tarif = TARIFS[selectedDestination];
            const date = document.getElementById('date').value;
            const heure = document.getElementById('heure').value;
            const passengers = document.getElementById('passengers').value;
            const luggage = document.getElementById('luggage').value;
            const flightNumber = document.getElementById('flightNumber').value;
            const prenom = document.getElementById('prenom').value;
            const nom = document.getElementById('nom').value;
            const telephone = document.getElementById('telephone').value;
            const email = document.getElementById('email').value;
            const notes = document.getElementById('notes').value;

            let trajetName = tarif.name;
            let price = tarif.price;
            let distanceInfo = '';

            if (selectedDestination === 'custom') {
                const depart = document.getElementById('customDepart').value;
                const arrivee = document.getElementById('customArrivee').value;
                trajetName = depart + ' ‚Üí ' + arrivee;
                price = calculatedPrice;
                if (calculatedDistance > 0) {
                    distanceInfo = ` (${calculatedDistance.toFixed(1)} km)`;
                }
            }

            // Appliquer la r√©duction parrainage
            let finalPrice = price;
            if (reductionParrainage > 0 && price > 0) {
                finalPrice = Math.max(0, price - reductionParrainage);
            }

            // Enregistrer dans Supabase
            try {
                const { data, error } = await supabase
                    .from('reservations')
                    .insert([{
                        client_name: `${prenom} ${nom}`,
                        client_phone: telephone,
                        client_email: email,
                        trajet: trajetName,
                        date: date,
                        time: heure,
                        passengers: parseInt(passengers),
                        luggage: parseInt(luggage),
                        flight_number: flightNumber || null,
                        notes: notes || null,
                        price: finalPrice || null,
                        price_original: price || null,
                        code_parrain: codeParrainValide ? codeParrainValide.code : null,
                        parrain_id: codeParrainValide ? codeParrainValide.id : null,
                        reduction: reductionParrainage || null,
                        distance: calculatedDistance || null,
                        status: 'pending'
                    }]);

                if (error) {
                    console.error('Erreur Supabase:', error);
                }

                // Si parrainage utilis√©, enregistrer pour le bonus parrain
                if (codeParrainValide) {
                    await supabase
                        .from('parrainages')
                        .insert([{
                            parrain_code: codeParrainValide.code,
                            parrain_id: codeParrainValide.id,
                            filleul_name: `${prenom} ${nom}`,
                            filleul_email: email,
                            reduction_filleul: reductionParrainage,
                            bonus_parrain: REDUCTION_PARRAINAGE,
                            bonus_utilise: false
                        }]);
                }
            } catch (err) {
                console.error('Erreur:', err);
            }

            // Envoyer email de confirmation au client
            const dateObj = new Date(date);
            const dateStr = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

            try {
                await emailjs.send('service_3lw4s81', 'template_fgt2uio', {
                    client_name: `${prenom} ${nom}`,
                    email: email,
                    trajet: trajetName,
                    date: dateStr,
                    heure: heure,
                    passengers: passengers + (passengers > 1 ? ' passagers' : ' passager'),
                    luggage: luggage + (luggage > 1 ? ' bagages' : ' bagage'),
                    price: price > 0 ? price + '‚Ç¨' : 'Sur devis'
                });
                console.log('Email de confirmation envoy√© au client');
            } catch (emailError) {
                console.error('Erreur envoi email client:', emailError);
            }

            // Envoyer email de notification √† Florent (pro + perso)
            try {
                const reservationDetails = `
Nouvelle r√©servation VTC !

TRAJET : ${trajetName}${distanceInfo}
DATE : ${dateStr}
HEURE : ${heure}
PASSAGERS : ${passengers}
BAGAGES : ${luggage}
${flightNumber ? 'VOL : ' + flightNumber : ''}

CLIENT : ${prenom} ${nom}
T√âL√âPHONE : ${telephone}
EMAIL : ${email}
${notes ? 'NOTES : ' + notes : ''}

PRIX : ${price > 0 ? price + '‚Ç¨' : '√Ä d√©finir'}${codeParrainValide ? ' (avec parrainage: ' + finalPrice + '‚Ç¨)' : ''}
                `.trim();

                // Email √† l'adresse pro
                await emailjs.send('service_3lw4s81', 'template_fgt2uio', {
                    client_name: 'Florent VTC',
                    email: 'contact@florent-vtc.fr',
                    trajet: 'NOUVELLE R√âSERVATION',
                    date: dateStr,
                    heure: heure,
                    passengers: reservationDetails,
                    luggage: '',
                    price: ''
                });
                console.log('Email envoy√© √† contact@florent-vtc.fr');

                // Email √† l'adresse perso
                await emailjs.send('service_3lw4s81', 'template_fgt2uio', {
                    client_name: 'Florent VTC',
                    email: 'florentivo95270@gmail.com',
                    trajet: 'NOUVELLE R√âSERVATION',
                    date: dateStr,
                    heure: heure,
                    passengers: reservationDetails,
                    luggage: '',
                    price: ''
                });
                console.log('Email envoy√© √† florentivo95270@gmail.com');
            } catch (emailError) {
                console.error('Erreur envoi email Florent:', emailError);
            }

            // Envoyer aussi par WhatsApp

            let message = `üöó *Nouvelle r√©servation VTC*\n\n`;
            message += `üìç *Trajet :* ${trajetName}${distanceInfo}\n`;
            message += `üìÖ *Date :* ${dateStr}\n`;
            message += `‚è∞ *Heure :* ${heure}\n`;
            message += `üë• *Passagers :* ${passengers}\n`;
            message += `üß≥ *Bagages :* ${luggage}\n`;
            if (flightNumber) message += `‚úàÔ∏è *Vol :* ${flightNumber}\n`;
            message += `\n`;
            message += `üë§ *Client :* ${prenom} ${nom}\n`;
            message += `üì± *T√©l :* ${telephone}\n`;
            message += `üìß *Email :* ${email}\n`;
            if (notes) message += `üìù *Notes :* ${notes}\n`;
            message += `\n`;
            if (codeParrainValide) {
                message += `üéÅ *Parrainage :* ${codeParrainValide.code} (-${reductionParrainage}‚Ç¨)\n`;
                message += `üí∞ *Prix :* ${price}‚Ç¨ ‚Üí *${finalPrice}‚Ç¨*`;
            } else {
                message += `üí∞ *Prix :* ${price > 0 ? price + '‚Ç¨' : '√Ä d√©finir'}`;
            }

            const encoded = encodeURIComponent(message);
            window.open('https://wa.me/33683669716?text=' + encoded, '_blank');
        });
    </script>
</body>
</html>
